var c=!1,s=null,w=null,u=null,a=null,g=null,f=null,y=null,p=null,x=null,d=null,v=null;function ee(){if(!s)return;let t=()=>{document.documentElement.contains(s)||document.documentElement.appendChild(s)};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t,{once:!0}):t()}async function te(){return v||(v=(async()=>{let t=globalThis.chrome&&chrome.runtime&&chrome.runtime.getURL?chrome.runtime.getURL("js/search.html"):"/js/search.html";try{let e=await fetch(t);if(!e.ok)throw new Error("Template fetch failed");let r=await e.text(),m=new DOMParser().parseFromString(r,"text/html").querySelector(".search-overlay");if(!m)throw new Error("No .search-overlay in template");return m.cloneNode(!0)}catch{let r=document.createElement("div");return r.className="search-overlay",r.innerHTML='<div class="search-panel"><input id="search-input" placeholder="Search tabs..." /><div id="results-container"></div><div id="loading" style="display:none">Loading...</div></div><div class="preview-panel"><div class="preview-title">Preview</div><div class="preview-url"></div><div class="preview-content">No tab selected</div></div>',r}})(),v)}async function o(){if(c)return K();c=!0,s=document.createElement("div"),s.style.all="initial",s.style.position="fixed",s.style.inset="0",s.style.zIndex="2147483647",w=s.attachShadow({mode:"open"});let t=document.createElement("link");t.setAttribute("rel","stylesheet");let e=globalThis.chrome&&chrome.runtime&&chrome.runtime.getURL?chrome.runtime.getURL("js/search.css"):"/js/search.css";return t.setAttribute("href",e),u=document.createElement("div"),u.className="overlay-root",w.append(t,u),ee(),a=(await te()).cloneNode(!0),u.appendChild(a),g=a.querySelector("#search-input"),f=a.querySelector("#results-container"),y=a.querySelector("#loading"),p=a.querySelector(".preview-title"),x=a.querySelector(".preview-url"),d=a.querySelector(".preview-content"),K()}function K(){return{host:s,shadow:w,overlayRoot:u,overlayEl:a,inputEl:g,resultsEl:f,loadingEl:y,previewTitleEl:p,previewUrlEl:x,previewContentEl:d}}function C(){return c||o(),g}function S(t){c||o(),u&&(u.style.display=t?"flex":"none")}function O(){return!!u&&u.style.display!=="none"}function R(){c||o(),g?.focus?.()}function $(){c||o(),f&&(f.innerHTML="")}function G(t,e,r=!1){c||o();let n=document.createElement("div");return n.className="result-item"+(r?" selected":""),n.innerHTML=`
    <div class="result-title"></div>
    <div class="result-group"></div>
  `,n.querySelector(".result-title").textContent=String(t??""),n.querySelector(".result-group").textContent=String(e??""),f?.appendChild(n),n}function I(t){c||o();let e=f?.querySelectorAll(".result-item");e&&e.forEach((r,n)=>{n===t?r.classList.add("selected"):r.classList.remove("selected")})}function U(t,e){c||o(),p&&(p.textContent=String(t??"")),d&&(d.textContent=String(e??""))}function b({title:t,url:e,groupTitle:r,lastAccessed:n}={}){if(c||o(),p&&(p.textContent=String(t??"")),x&&(x.textContent=String(e??"")),d){d.innerHTML="";let h=(V,Z)=>{let k=document.createElement("div");k.className="preview-meta-row";let P=document.createElement("span");P.className="preview-label",P.textContent=V;let q=document.createElement("span");return q.className="preview-value",q.textContent=Z,k.append(P,q),k},m=r?String(r):"(No group)";d.appendChild(h("Group:",m));let i="\u2014";if(n!=null&&isFinite(n))try{i=new Date(Number(n)).toLocaleString()}catch{}d.appendChild(h("Last accessed:",i))}}function E(t){c||o(),y&&(y.style.display=t?"block":"none")}function Q(){try{s?.remove()}finally{c=!1,s=null,w=null,u=null,a=null,g=null,f=null,y=null,p=null,d=null}}var T=class{constructor(e=120){this.delay=e,this.id=null}run(e){this.id&&clearTimeout(this.id),this.id=setTimeout(()=>{this.id=null;try{e()}catch{}},this.delay)}flush(e){this.id&&(clearTimeout(this.id),this.id=null);try{e()}catch{}}},_=class{search(e){return new Promise(r=>{try{chrome.runtime.sendMessage({type:"fuzzySearch",query:String(e||"")},n=>{if(!n||n.ok!==!0)return r([]);r(Array.isArray(n.results)?n.results:[])})}catch{r([])}})}activateTab(e){return new Promise(r=>{try{chrome.runtime.sendMessage({type:"activateTab",tabId:e},()=>r())}catch{r()}})}},L=class{constructor(){this.items=[],this.selectedIdx=-1}size(){return this.items.length}keyOf(e){let r=(e&&(typeof e.id=="number"?e.id:e.id||""))+"",n=e&&e.url||"",h=e&&e.title||"";return`${r}|${n}|${h}`}equals(e){if(!Array.isArray(e)||e.length!==this.items.length)return!1;for(let r=0;r<e.length;r++)if(this.keyOf(e[r])!==this.keyOf(this.items[r]))return!1;return!0}setItems(e){return this.equals(e)?!1:(this.items=Array.isArray(e)?e:[],this.items.length===0?this.selectedIdx=-1:(this.selectedIdx<0&&(this.selectedIdx=0),this.selectedIdx>=this.items.length&&(this.selectedIdx=this.items.length-1)),!0)}move(e){if(!this.items.length)return null;let r=this.items.length;return this.selectedIdx=(this.selectedIdx+e+r)%r,this.current()}current(){return this.selectedIdx<0||this.selectedIdx>=this.items.length?null:this.items[this.selectedIdx]}};var z=!1,N=!1,B=!1,re=new T(120),W=new _,l=new L,D=0,A=null;function F(){return z||(z=!0,A||(A=o().then(()=>{ne()}))),A}function ne(){N||(N=!0,document.addEventListener("keydown",j,{capture:!1}))}function ie(){N&&(N=!1,document.removeEventListener("keydown",j,{capture:!1}))}function ue(t){j(t)}function j(t){if(!O())return;let e=String(t.key);if(["Escape","ArrowUp","ArrowDown","Enter","Tab"].includes(e)&&(t.preventDefault(),t.stopPropagation()),e==="Escape"){X();return}if(e==="ArrowDown"){M(1);return}if(e==="ArrowUp"){M(-1);return}if(e==="Enter"){le();return}if(e==="Tab"){M(t.shiftKey?-1:1);return}}function M(t){let e=l.move(t);e&&(I(l.selectedIdx),b({title:e.title,url:e.url||"",groupTitle:e.groupTitle||e.group||"",lastAccessed:e.lastAccessed}))}function le(){let t=l.current();if(t&&typeof t.id=="number")try{W.activateTab(t.id)}catch{}X()}function de(){(async()=>{await F(),S(!0),globalThis.__wer_search_open=!0,Y(),H(),R()})().catch(e=>{})}function X(){(async()=>{await F(),S(!1),globalThis.__wer_search_open=!1})().catch(()=>{})}function he(){(async()=>{await F();let e=!O();S(e),globalThis.__wer_search_open=e,e&&(Y(),H(),R())})().catch(e=>{})}function fe(){try{ie(),Q()}finally{z=!1}}function pe(){return!!globalThis.__wer_search_open}function J(){if($(),!l.size()){U("Preview","No tab selected"),l.selectedIdx=-1;return}l.items.forEach((e,r)=>G(e.title,e.groupTitle||e.group||"",r===l.selectedIdx)),l.selectedIdx<0&&(l.selectedIdx=0,I(l.selectedIdx));let t=l.current();b({title:t.title,url:t.url||"",groupTitle:t.groupTitle||t.group||"",lastAccessed:t.lastAccessed})}function Y(){if(B)return;let t=C();t&&(B=!0,t.addEventListener("input",()=>{re.run(()=>{H()})}))}function H(){let e=C()?.value||"";E(!0);let r=++D;W.search(e).then(n=>{if(r!==D)return;let h=n.map(i=>({id:typeof i?.id=="number"?i.id:typeof i?.id=="string"?Number(i.id):void 0,title:i?.title||"",groupTitle:i?.group_title||"",group:i?.group_title||"",url:i?.url||"",lastAccessed:typeof i?.last_accessed=="number"?i.last_accessed:void 0}));if(l.setItems(h))J();else{let i=l.current();i?(I(l.selectedIdx),b({title:i.title,url:i.url||"",groupTitle:i.groupTitle||i.group||"",lastAccessed:i.lastAccessed})):U("Preview","No tab selected")}E(!1)}).catch(()=>{r===D&&(l.setItems([]),J(),E(!1))})}export{fe as cleanupSearchUI,X as closeSearchPanel,ue as handleSearchKeydown,F as initSearchUI,pe as isSearchOpen,de as openSearchPanel,he as toggleSearchPanel};
